<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>二十二 订阅服务注册消息驱动网关映射 | 「hirikiのblog」</title><meta name="keywords" content="API网关,服务发现,Redis发布订阅"><meta name="author" content="hiriki"><meta name="copyright" content="hiriki"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="二十二 订阅服务注册消息驱动网关映射"><meta name="application-name" content="二十二 订阅服务注册消息驱动网关映射"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="二十二 订阅服务注册消息驱动网关映射"><meta property="og:url" content="http://www.sherry.zone/posts/ab0d0ec1.html"><meta property="og:site_name" content="「hirikiのblog」"><meta property="og:description" content="通过 Redis 发布和订阅的模块，在网关注册中心和网关助手中分别提供相关功能，在应用接口注册到网关中心后触发通知，让网关助手完成新增接口的映射处理。 设计 这一章节的开发有一个需求的背景，我们的网关算力服务在启动过程中会拉取注册中心的接口信息，到网关算法上进行注册操作。通过这样的一个步骤，才能让我"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg"><meta property="article:author" content="hiriki"><meta property="article:tag" content="Java,算法,代码,博客,Butterfly,Hexo,Ray,hiriki,sherry"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg"><meta name="description" content="通过 Redis 发布和订阅的模块，在网关注册中心和网关助手中分别提供相关功能，在应用接口注册到网关中心后触发通知，让网关助手完成新增接口的映射处理。 设计 这一章节的开发有一个需求的背景，我们的网关算力服务在启动过程中会拉取注册中心的接口信息，到网关算法上进行注册操作。通过这样的一个步骤，才能让我"><link rel="shortcut icon" href="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public%2Ffavicon.ico"><link rel="canonical" href="http://www.sherry.zone/posts/ab0d0ec1"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"👀跑哪里去了～","backTitle":"🍥欢迎肥来～"},
  LA51: {"enable":true,"ck":"3HwDgY7UEBSxOADx","LingQueMonitorID":"3HwDgY7UEBSxOADx"},
  greetingBox: {"enable":true,"default":"晚上好","list":[{"greeting":"晚安","startTime":0,"endTime":5},{"greeting":"早上好鸭, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安","startTime":12,"endTime":14},{"greeting":"辛苦啦！","startTime":14,"endTime":18},{"greeting":"18点喽, 奖励一顿丰盛的大餐吧。","startTime":18,"endTime":19},{"greeting":"晚上好, 在属于自己的时间好好放松~","startTime":20,"endTime":22}]},
  twikooEnvId: 'https://twikoo.sherry.pub/',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: {"appId":"UM5B1S43V2","apiKey":"a6b29d3081e9507f77ad033cb51abd1d","indexName":"blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hiriki","link":"链接: ","source":"来源: 「hirikiのblog」","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '「hirikiのblog」',
  title: '二十二 订阅服务注册消息驱动网关映射',
  postAI: '',
  pageFillDescription: '设计, 实现, 注册中心, 消息发布, 消息监听推送配置 PublisherConfig, 消息发布者 Publisher, MessageServiceImpl 消息服务, 获取 Redis 配置信息, 事件通知, 网关助手, 连接服务, 消息订阅, 网关SDK, 事件通知注册, 应用服务注册, 测试, RPC 应用服务(SDK)未启动：, RPC 应用服务(SDK)启动后：, Postman, 思考, 大致流程, Redis消息订阅发布, Redis事件发布端, Redis 监听器, 面试中可能会问到的问题, Redis 发布订阅（Publish/Subscribe）与消息队列 MQ 的区别？, 那 Redis 发布订阅有什么局限性？, 那什么场景选择 Redis 发布订阅更好？为什么选择 Redis 发布订阅做网关注册的通知？, Redis 发布订阅为什么实时性高延迟低？通过发布和订阅的模块在网关注册中心和网关助手中分别提供相关功能在应用接口注册到网关中心后触发通知让网关助手完成新增接口的映射处理设计这一章节的开发有一个需求的背景我们的网关算力服务在启动过程中会拉取注册中心的接口信息到网关算法上进行注册操作通过这样的一个步骤才能让我们在访问网关接口的时候泛化调用到对应的服务那么当网关算力服务已经是部署好后再有新的服务或者接口注册到网关注册中心的时候那么网关算力该如何把这些信息获取到并完成网关的映射呢可以通过几个方案来处理接口的轮询在网关算力助手服务中通过不断的像网关中心请求接口的方式拉取到所有需要被注册的接口这里可以在已经拉取的服务接口上在中做数据的记录减少重复拉取不过这样的方式会给网关中心带来不小的压力网关引擎在生命周期初始化中另起一个线程在后台不断重复拉取所有服务并存入缓存显然不论是对于网关引擎还是注册中心都消耗占用不少资源服务的连接在网关助手类与网关中心建立一个的服务由网关中心接收到新的接口注册时候进行信息通知但这样的长链接已经会占用不少的资源网关引擎再启动一个服务端监听端口不能和己有网关通信服务监听端口相同注册中心启动一个客户端和建立连接每次有新的服务接口注册进来后通过管道通知服务端拉取注册新的接口但维持这样的长链接也会占用不少资源事件的通知其实通过事件来通知是一个比较合适的方式比如你可以使用等方式也可以使用的发布和订阅在有接口变化的时候可以通过消息的推送让网关算力获取到变化的接口信息进行注册处理那么这里就是通过的方式进行处理最佳实践使用事件发布订阅机制异步进行比如这里网关引擎与注册中心采用的发布订阅模式进行通信新的应用接口启动注册后触发注册中心的事件发布机制向网关引擎推送新注册系统的信息收到后根据查询对应的接口信息进行映射此处每启动一个新的应用服务注册进注册中心时都是以为单位注册时需要保存应用下的所有接口所有方法因此事件推送时仅需要传递即可而后续如果细化到只注册某个方法时也需要细化拆分注册不同的模块根据不同的信息进行不同的映射处理后期这里或许可以考虑策略模式在工程中添加发布消息模块并提供应用服务注册后的事件通知操作这个通知只会通知给对应的网关算力服务不会全局通知在工程中开发订阅消息模块当收到注册中心的消息推送时则根据系统的标识信息进行拉取服务注意这里你可以进行细化只把变更的信息一条条推送给网关注册减少接口的拉取这里可以在注册接口时向注册中心查询判断是否该接口已经注册存在于数据库中如果是新注册就将该接口的信息推送给注册中心注册中心再将该消息发布对应的网关引擎监听到该信息后根据接口信息向网关通信组件中的注册映射在工程中添加对网关注册中心接口的调用当所有的服务注册完成后调用接口进行通知实现注册中心消息发布在注册中心服务中提供的发布模块并在应用服务注册接口后调用该方法添加依赖配置消息监听推送配置消息监听推送配置这是一个消息监听推送配置类它使用了的注解表示这是一个配置类注解告诉容器这个类中定义了一些对象的配置在这个类中定义了一个名为的注解告诉容器这个方法将返回一个对象该对象将被注册为一个并且可以被其他类自动注入方法的参数是表示需要从容器中获取一个连接工厂对象作为参数在方法内部首先创建了一个对象并将对象设置为它的连接工厂是提供的一个接口用于获取连接的工厂类它可以通过配置来创建实例或者通过自动配置的方式从应用程序的上下文中获取在应用程序中可以通过配置文件或者编程方式来配置连接工厂通常可以在或文件中配置连接信息例如的主机名端口号密码等会自动读取这些配置并根据配置创建一个的实例另外还可以通过编程方式来配置在这种情况下可以在配置类中手动创建对象并设置连接相关的属性例如主机名端口号密码等总结起来可以通过配置文件或者编程方式进行配置从而创建一个可以用于获取连接的工厂实例具体的配置方式可以根据项目的需求和使用的框架来确定然后通过调用的方法将设置为默认的序列化器是一个用于将对象序列化为格式的序列化器最后方法返回了对象这个配置类的作用是创建一个对象并设置了默认的序列化器以便在使用进行消息监听推送时能够将对象以格式序列化存储到中消息发布者消息发布者这是一个消息发布者用于向消息队列发送消息它使用了框架的来操作其中是注入的实例方法用于将消息发送到指定的主题并且可以传递任何类型的消息在调用方法时它会将消息转换为支持的格式并将其发送到指定的主题消息服务消息服务这里包装所在端口供外部查询获取方便网关引擎配置而不用手动去文件中配置减少了用户的操作也统一了配置让注册中心真正作为了整个网关的中转站配置中心另外也向外提供了推送消息的服务获取配置信息网关配置管理服务分组网关注册服务关联查询网关服务配置项信息查询网关服务配置项信息异常注册网关服务节点分组标识网关标识网关名称网关地址注册网关服务节点注册网关服务节点异常查询分配到网关下的待注册系统信息系统接口方法查询分配到网关下的待注册系统信息系统接口方法异常查询配置中心配置信息成功查询配置中心配置信息失败事件通知服务注册管理注册应用服务注册应用服务重复注册应用服务失败注册应用接口注册应用接口重复注册应用接口失败注册应用接口方法注册应用接口方法重复注册应用接口方法应用信息注册完成通知成功应用信息注册完成通知失败这里通了一个注册事件既可以被使用也可以被运用平台调用进行消息推送让网关服务拉取最新的系统信息网关助手为了能收到来自注册中心的消息推送那么网关助手服务也需要连接到对应的服务上那么这里并不需要用户在网关助手类中配置的连接信息而是通过优化的方式从注册中心拉取连接信息到网关助手中进行注册因为只有这样才能减少用户的配置并做到统一的管理连接服务拉取注册中心的配置信息构建服务默认配置信息一般这些配置可以被抽取出来创建配置实例化链接对象方法用于创建连接工厂它通过调用的方法获取注册中心的配置信息然后根据该信息构建服务的连接配置是客户端的配置类用于配置连接池的参数如最大连接数最大空闲连接数连接超时时间等注意一般都是固定配置也可以从注册中心进行拉取方法用于创建消息监听器适配器它将类中的方法作为消息监听器方法用于创建消息监听容器它使用连接工厂和消息监听器适配器来创建一个消息监听容器并将其绑定到指定的主题上在这个例子中它将容器绑定到了类中定义的网关作为主题上这样当有消息发送到该主题时该容器就会接收到并调用对应的消息监听器处理该消息消息订阅网关应用与链接调用网关注册和接口拉取注册网关服务每一个用于转换协议泛化调用到接口的网关都是一个算力这些算力需要注册网关配置中心网关服务启动失败停止服务拉取网关配置每个网关算力都会在注册中心分配上需要映射的服务信息包括系统接口方法网关服务注册映射为空请排查是否检索到此网关算力需要拉取的配置数据创建配置信息加载注册注册系统服务接口信息网关服务注册映射系统接口方法应用容器关闭网关服务关闭应用容器关闭网关服务关闭失败事件通知接收注册中心推送消息后续消息接收方法直接通过注册映射将注册映射逻辑抽取出来作为单独的方法通过这样的方式现在我们拉取接口一方面是网关助手系统也就是网关引擎启动的时候进行拉取另外一种是已经在运行时候通过事件的通知进行拉取注意这里的增加了参数也就是网关中心的方法增加了参数也就增加了一下逻辑如果未指定则查询当前网关下的所有系统指定则定向拉取系统第一次网关引擎初始化启动时未指定注册当前网关下的所有系统接口之后就通过事件通知指定了只注册指定系统下的接口网关事件通知注册网关中心服务应用服务注册异常链接资源不可用向网关中心注册应用服务注册结果注册应用服务异常应用服务接口注册异常链接资源不可用向网关中心注册应用接口服务注册结果向网关中心注册应用接口服务异常应用服务接口注册方法异常链接资源不可用向网关中心注册应用接口方法服务注册结果向网关中心注册应用接口方法服务异常应用信息注册完成通知异常链接资源不可用应用信息注册完成通知注册结果向网关中心注册完成通知异常应用服务注册应用服务注册系统信息应用注册系统信息接口信息应用注册接口信息方法信息解析参数应用注册方法信息注册完成执行事件通知这里后续可以在注册接口时向注册中心查询判断是否该接口已经注册存在于数据库中如果是新注册就将该接口的信息推送给注册中心注册中心再将该消息发布对应的网关引擎监听到该信息后根据接口信息向网关通信组件中的注册映射测试启动容器启动注册中心启动服务清空数据库为的就是在启动的时候不让它拉取到任何接口信息当后续注册新的接口信息时候再拉取启动注册中心保证后续的流程可以启动打包最新部署镜像文件到容器启动观察中的日志信息是否有映射完成操作应用服务未启动应用服务启动后思考大致流程网关引擎初始化启动时拉取注册中心数据库中已有的所有系统应用接口信息完成注册并根据当前网关监听注册中心当有一个新的应用服务加入网关时将其带有注解的类和方法的信息持久化到网关中心的数据库中之后调用事件发布接口通知网关中心发布消息网关中心接收到发布请求后通过发布消息网关引擎运行中监听到消息发布接收到网关中心推送过来的之后根据拉取该系统下所有的接口信息并根据完成通信组件的配置注册消息订阅发布一般都是用于缓存较多这里记录一下用于事件推送的方法事件发布端发布消息指明接收方通信信道以及消息内容监听器负责设置连接参数服务地址是提供的一个接口用于获取连接的工厂类它可以通过配置来创建实例或者通过自动配置的方式从应用程序的上下文中获取在应用程序中可以通过配置文件或者编程方式来配置连接工厂通常可以在或文件中配置连接信息例如的主机名端口号密码等会自动读取这些配置并根据配置创建一个的实例另外还可以通过编程方式来配置在这种情况下可以在配置类中手动创建对象并设置连接相关的属性例如主机名端口号密码等总结起来可以通过配置文件或者编程方式进行配置从而创建一个可以用于获取连接的工厂实例具体的配置方式可以根据项目的需求和使用的框架来确定在中注入连接工厂并修改配置从注册中心拉取的端口信息创建客户端连接不需要在重新配置服务地址减少用户的操作也更方便统一配置注入消息监听器容器需要设置连接工厂和监听器适配器并将消息通信与监听器适配器绑定指明消息处理委托对象以及消息处理方法最终发布方的消息会被该方法接收面试中可能会问到的问题发布订阅与消息队列的区别发布订阅和消息队列都是用于实现消息传递的机制但它们的实现方式和应用场景略有不同发布订阅模式是一种广播机制它允许订阅者接收到发布者发送的消息发布者将消息发送到指定的频道而订阅者则可以订阅一个或多个频道以接收该频道中的所有消息这种模式适用于消息的广播场景如实时聊天新闻推送等消息队列则是一种点对点的消息传递方式它将消息发送到队列中然后由消费者从队列中取出并处理该消息消息队列可以保证消息的可靠性传递同时也可以实现消息的异步处理从而提高系统的吞吐量和可伸缩性消息队列适用于异步处理任务调度等场景因此发布订阅和消息队列虽然都可以实现消息传递但在应用场景和实现方式上略有不同需要根据实际需求选择合适的机制那发布订阅有什么局限性发布订阅模式的局限性主要包括以下几点可靠性发布订阅模式不保证消息的可靠性因为订阅者只能接收到自己订阅的消息而无法保证消息是否已经被正确地传递给所有的订阅者也无法保证消息是否已经被正确地处理消息持久化发布订阅模式不支持消息的持久化即当订阅者断开连接时它将无法接收到在其离线期间发送的消息扩展性发布订阅模式不适合处理大量的消息因为它只能在单个实例中进行处理无法进行水平扩展消息顺序发布订阅模式无法保证消息的顺序因为它是异步的消息的传递顺序可能与发布的顺序不一致因此在实际应用中如果需要保证消息的可靠性持久化顺序和扩展性可以考虑使用消息队列等其他的解决方案那什么场景选择发布订阅更好为什么选择发布订阅做网关注册的通知发布订阅模式适用于以下场景实时性要求高发布订阅模式是异步的消息的传递速度非常快适合处理需要实时性的场景如在线聊天实时通知等简单的消息传递发布订阅模式非常适合处理简单的消息传递如事件通知状态更新等低延迟的数据处理发布订阅模式具有低延迟的特点适合需要快速处理数据的场景如实时数据分析实时数据监控等简单的数据结构发布订阅模式的数据结构非常简单易于使用和维护适合处理简单的数据结构总的来说发布订阅模式适合处理实时性要求高简单的消息传递低延迟的数据处理简单的数据结构等场景如果需要处理复杂的消息传递保证消息的可靠性持久化顺序和扩展性可以考虑使用消息队列等其他的解决方案发布订阅为什么实时性高延迟低发布订阅模式具有实时性高延迟低的特点主要原因有以下几点异步通信发布订阅模式采用异步通信方式发布者将消息发布到服务器后不需要等待订阅者接收消息的响应即可继续处理其他任务这样可以大大提高消息的传递速度内存存储是一种基于内存存储的数据库数据的读写非常快可以在微秒级别内完成这样可以大大缩短消息的传递时间单线程模型采用单线程模型避免了多线程之间的线程切换和锁竞争这样可以减少消息传递的延迟网络协议采用高效的网络协议如协议可以大大提高消息的传递效率综上所述发布订阅模式具有实时性高延迟低的特点这主要得益于采用了异步通信内存存储单线程模型和高效的网络协议等优化措施',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-11 17:52:00',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 8 || hour >= 21
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/avatar2.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">「hirikiのblog」</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/photos/"><span> 相册</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><span> 留言</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><span> 关于</span></a></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/API%E7%BD%91%E5%85%B3/" style="font-size: 1.05rem;">API网关<sup>29</sup></a><a href="/tags/DDD/" style="font-size: 1.05rem;">DDD<sup>2</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>1</sup></a><a href="/tags/HTTP%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 1.05rem;">HTTP常见面试题<sup>8</sup></a><a href="/tags/HashMap/" style="font-size: 1.05rem;">HashMap<sup>2</sup></a><a href="/tags/JDK/" style="font-size: 1.05rem;">JDK<sup>1</sup></a><a href="/tags/JRE/" style="font-size: 1.05rem;">JRE<sup>1</sup></a><a href="/tags/JVM/" style="font-size: 1.05rem;">JVM<sup>5</sup></a><a href="/tags/JWT/" style="font-size: 1.05rem;">JWT<sup>1</sup></a><a href="/tags/LVS/" style="font-size: 1.05rem;">LVS<sup>1</sup></a><a href="/tags/MIT-6-824/" style="font-size: 1.05rem;">MIT 6.824<sup>2</sup></a><a href="/tags/MapReduce/" style="font-size: 1.05rem;">MapReduce<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>6</sup></a><a href="/tags/Netty/" style="font-size: 1.05rem;">Netty<sup>5</sup></a><a href="/tags/Nginx/" style="font-size: 1.05rem;">Nginx<sup>3</sup></a><a href="/tags/Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/" style="font-size: 1.05rem;">Redis发布订阅<sup>1</sup></a><a href="/tags/Shiro/" style="font-size: 1.05rem;">Shiro<sup>1</sup></a><a href="/tags/SpringBoot-Starter/" style="font-size: 1.05rem;">SpringBoot Starter<sup>1</sup></a><a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 1.05rem;">事务<sup>2</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/" style="font-size: 1.05rem;">内存区域<sup>1</sup></a><a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" style="font-size: 1.05rem;">动态代理<sup>1</sup></a><a href="/tags/%E5%90%AF%E5%8A%A8%E5%BC%95%E6%93%8E/" style="font-size: 1.05rem;">启动引擎<sup>1</sup></a><a href="/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" style="font-size: 1.05rem;">垃圾回收<sup>1</sup></a><a href="/tags/%E5%AE%B9%E5%99%A8%E4%B8%8A%E4%B8%8B%E6%96%87/" style="font-size: 1.05rem;">容器上下文<sup>1</sup></a><a href="/tags/%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1/" style="font-size: 1.05rem;">库表设计<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">操作系统<sup>10</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E6%BA%90%E6%8A%BD%E8%B1%A1/" style="font-size: 1.05rem;">数据源抽象<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" style="font-size: 1.05rem;">服务发现<sup>8</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C/" style="font-size: 1.05rem;">服务注册<sup>2</sup></a><a href="/tags/%E6%A0%91/" style="font-size: 1.05rem;">树<sup>1</sup></a><a href="/tags/%E6%B3%9B%E5%8C%96%E8%B0%83%E7%94%A8/" style="font-size: 1.05rem;">泛化调用<sup>1</sup></a><a href="/tags/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/" style="font-size: 1.05rem;">注册中心<sup>5</sup></a><a href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" style="font-size: 1.05rem;">类加载机制<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">计算机网络<sup>13</sup></a><a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 1.05rem;">负载均衡<sup>1</sup></a><a href="/tags/%E8%B7%A8%E5%9F%9F/" style="font-size: 1.05rem;">跨域<sup>1</sup></a><a href="/tags/%E8%BF%90%E8%90%A5%E5%90%8E%E5%8F%B0/" style="font-size: 1.05rem;">运营后台<sup>2</sup></a><a href="/tags/%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6/" style="font-size: 1.05rem;">通信组件<sup>9</sup></a><a href="/tags/%E9%94%81/" style="font-size: 1.05rem;">锁<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">46</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">九月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">七月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">五月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">24</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" itemprop="url">项目笔记</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/API%E7%BD%91%E5%85%B3/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>API网关</span></a><a class="article-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>服务发现</span></a><a class="article-meta__tags" href="/tags/Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Redis发布订阅</span></a></span></div></div><h1 class="post-title" itemprop="name headline">二十二 订阅服务注册消息驱动网关映射</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-05-31T02:32:00.000Z" title="发表于 2023-05-31 10:32:00">2023-05-31</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-08-11T09:52:00.000Z" title="更新于 2023-08-11 17:52:00">2023-08-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="二十二 订阅服务注册消息驱动网关映射"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为重庆"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>重庆</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/ab0d0ec1.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://www.sherry.zone/posts/ab0d0ec1.html"><header><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" itemprop="url">项目笔记</a><a href="/tags/API%E7%BD%91%E5%85%B3/" tabindex="-1" itemprop="url">API网关</a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" tabindex="-1" itemprop="url">服务发现</a><a href="/tags/Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/" tabindex="-1" itemprop="url">Redis发布订阅</a><h1 id="CrawlerTitle" itemprop="name headline">二十二 订阅服务注册消息驱动网关映射</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hiriki</span><time itemprop="dateCreated datePublished" datetime="2023-05-31T02:32:00.000Z" title="发表于 2023-05-31 10:32:00">2023-05-31</time><time itemprop="dateCreated datePublished" datetime="2023-08-11T09:52:00.000Z" title="更新于 2023-08-11 17:52:00">2023-08-11</time></header><p>通过 Redis 发布和订阅的模块，在网关注册中心和网关助手中分别提供相关功能，在应用接口注册到网关中心后触发通知，让网关助手完成新增接口的映射处理。</p>
<h1 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-设计.png" alt="22-设计"></p>
<p>这一章节的开发有一个需求的背景，我们的网关算力服务在启动过程中会拉取注册中心的接口信息，到网关算法上进行注册操作。通过这样的一个步骤，才能让我们在访问网关接口的时候，泛化调用到对应的 RPC 服务。<br>那么，当网关算力服务已经是部署好后，再有新的服务或者接口注册到网关注册中心的时候，那么网关算力该如何把这些信息获取到并完成网关的映射呢？<br>可以通过几个方案来处理;</p>
<ol>
<li><p>接口的轮询，在网关算力 api-gateway-assist 助手服务中通过不断的像网关中心请求接口的方式，拉取到所有需要被注册的接口。这里可以在已经拉取的服务接口上，在Redis中做数据的记录，减少重复拉取。不过这样的方式会给网关中心带来不小的压力。</p>
<p>网关引擎在Spring生命周期初始化中，另起一个线程，在后台while(true)不断重复拉取所有服务，并存入缓存。</p>
<p>显然不论是对于网关引擎还是注册中心都消耗占用不少资源。</p>
</li>
<li><p>服务的连接，在网关助手类与网关中心建立一个 Netty 的服务，由网关中心接收到新的接口注册时候进行信息通知。但这样的长链接，已经会占用不少的资源。</p>
<p>网关引擎再启动一个 Netty 服务端(监听端口不能和己有网关通信服务监听端口相同)，注册中心启动一个 Netty 客户端和 engine 建立连接，每次有新的服务接口注册进来后，通过管道 writeAndFlush(systemld) 通知服务端，拉取注册新的接口。但维持这样的长链接也会占用不少资源。</p>
</li>
<li><p>事件的通知，其实通过事件来通知是一个比较合适的方式，比如你可以使用 MQ、ZK等方式，也可以使用 Redis 的发布和订阅。在有接口变化的时候，可以通过消息的推送，让网关算力获取到变化的接口信息进行注册处理。那么这里就是通过 Redis 的方式进行处理。</p>
<p>最佳实践：使用事件发布订阅机制异步进行，比如 Redis 、MQ，这里网关引擎与注册中心采用 Redis 的发布订阅模式进行通信。新的应用接口启动注册后，触发注册中心的事件发布机制，gateway-center 向网关引擎推送新注册系统的信息，gateway-assist 收到后根据 systemId 查询对应的接口信息进行映射。</p>
</li>
</ol>
<p>此处每启动一个新的 Rpc 应用服务注册进注册中心时，都是以 systemld 为单位，assist 注册时需要保存应用下的所有接口+所有方法。因此事件推送时仅需要传递 systemld 即可。而后续如果细化到只注册某个方法时，addmapper也需要细化拆分注册不同的模块，根据不同的信息进行不同的映射处理。(后期这里或许可以考虑策略模式？</p>
<ol>
<li><p>在 api-gateway-center 工程中添加 Redis 发布消息模块，并提供应用服务注册后的事件通知操作。这个通知只会通知给对应的网关算力服务，不会全局通知。</p>
</li>
<li><p>在 api-gateway-assist 工程中开发 Redis 订阅消息模块，当收到注册中心的消息推送时，则根据系统的标识信息进行拉取服务。注意这里你可以进行细化，只把变更的信息一条条推送给网关注册，减少接口的拉取。</p>
<p>(这里可以在 sdk 注册接口时，向注册中心查询判断是否该接口已经注册，存在于数据库中，如果是新注册就将该接口的信息推送给注册中心，注册中心再将该消息发布，对应的网关引擎监听到该信息后，根据接口信息向网关通信组件 core 中的 Configuration 注册映射。</p>
</li>
<li><p>在 api-gateway-sdk 工程中添加对网关注册中心接口的调用，当所有的服务注册完成后，调用接口进行通知。</p>
</li>
</ol>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><h3 id="消息发布"><a href="#消息发布" class="headerlink" title="消息发布"></a>消息发布</h3><p>在 api-gateway-center 注册中心服务中提供 Redis 的发布模块，并在应用服务注册接口后调用该方法。</p>
<p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>application.yml 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
<h4 id="消息监听推送配置-PublisherConfig"><a href="#消息监听推送配置-PublisherConfig" class="headerlink" title="消息监听推送配置 PublisherConfig"></a>消息监听推送配置 PublisherConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.center.domain.message.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.support.spring.FastJsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/31 10:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> Redis 消息监听推送配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PublisherConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisMessageTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(connectionFactory);</span><br><span class="line">        template.setDefaultSerializer(<span class="keyword">new</span> <span class="title class_">FastJsonRedisSerializer</span>&lt;&gt;(Object.class));</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这是一个 Redis 消息监听推送配置类。它使用了Spring的注解@Configuration，表示这是一个配置类。</p>
<p>@Configuration 注解告诉 Spring 容器，这个类中定义了一些 Bean 对象的配置。在这个类中定义了一个名为 redisMessageTemplate 的 Bean。</p>
<p>@Bean 注解告诉 Spring 容器，这个方法将返回一个对象，该对象将被注册为一个 Bean ，并且可以被其他类自动注入。</p>
<p>方法 redisMessageTemplate 的参数是 RedisConnectionFactory ，表示需要从 Spring 容器中获取一个 Redis 连接工厂对象作为参数。</p>
<p>在方法内部，首先创建了一个RedisTemplate对象，并将 RedisConnectionFactory 对象设置为它的连接工厂。</p>
<p><strong>RedisConnectionFactory 是 Spring Data Redis 提供的一个接口，用于获取 Redis 连接的工厂类。它可以通过配置来创建实例，或者通过自动配置的方式从应用程序的上下文中获取。</strong></p>
<p><strong>在 Spring Boot 应用程序中，可以通过配置文件或者编程方式来配置 Redis 连接工厂。通常，可以在 application.properties 或 application.yml 文件中配置 Redis 连接信息，例如 Redis 的主机名、端口号、密码等。Spring Boot 会自动读取这些配置，并根据配置创建一个 RedisConnectionFactory 的实例。</strong></p>
<p><strong>另外，还可以通过编程方式来配置 RedisConnectionFactory。在这种情况下，可以在 Spring 配置类中手动创建 RedisConnectionFactory 对象，并设置连接相关的属性，例如主机名、端口号、密码等。</strong></p>
<p><strong>总结起来，RedisConnectionFactory 可以通过配置文件或者编程方式进行配置，从而创建一个可以用于获取 Redis 连接的工厂实例。具体的配置方式可以根据项目的需求和使用的框架来确定。</strong></p>
<p>然后，通过调用 template 的setDefaultSerializer方法，将 FastJsonRedisSerializer 设置为默认的序列化器。FastJsonRedisSerializer 是一个用于将对象序列化为JSON格式的序列化器。</p>
<p>最后，方法返回了 RedisTemplate 对象。</p>
<p>这个配置类的作用是创建一个 RedisTemplate 对象，并设置了默认的序列化器，以便在使用 RedisTemplate 进行消息监听推送时，能够将对象以 JSON 格式序列化存储到Redis中。</p>
</blockquote>
<h4 id="消息发布者-Publisher"><a href="#消息发布者-Publisher" class="headerlink" title="消息发布者 Publisher"></a>消息发布者 Publisher</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.center.domain.message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/31 10:34</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息发布者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Publisher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisMessageTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Publisher</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisMessageTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisMessageTemplate = redisMessageTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pushMessage</span><span class="params">(String topic, Object message)</span> &#123;</span><br><span class="line">        redisMessageTemplate.convertAndSend(topic, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这是一个消息发布者，用于向 Redis 消息队列发送消息。它使用了 Spring 框架的 RedisTemplate 来操作 Redis，其中 redisMessageTemplate 是注入的 RedisTemplate 实例。pushMessage 方法用于将消息发送到指定的主题（topic），并且可以传递任何类型的消息（message）。在调用 redisMessageTemplate.convertAndSend 方法时，它会将消息转换为Redis支持的格式，并将其发送到指定的主题。</p>
</blockquote>
<h4 id="MessageServiceImpl-消息服务"><a href="#MessageServiceImpl-消息服务" class="headerlink" title="MessageServiceImpl 消息服务"></a>MessageServiceImpl 消息服务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.center.domain.message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.application.IMessageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/31 10:31</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IMessageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Publisher publisher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">queryRedisConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; config = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        config.put(<span class="string">&quot;host&quot;</span>,host);</span><br><span class="line">        config.put(<span class="string">&quot;port&quot;</span>,String.valueOf(port));</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pushMessage</span><span class="params">(String gatewayId, Object message)</span> &#123;</span><br><span class="line">        publisher.pushMessage(gatewayId, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里包装 Redis 所在IP端口供外部查询获取，方便网关引擎配置，而不用手动去yml文件中配置，减少了用户的操作，也统一了 Redis 配置。让注册中心真正作为了整个 API 网关的中转站、配置中心。另外也向外提供了推送消息的服务。</p>
</blockquote>
<h3 id="获取-Redis-配置信息"><a href="#获取-Redis-配置信息" class="headerlink" title="获取 Redis 配置信息"></a>获取 Redis 配置信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.center.interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.application.IConfigManageService;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.application.IMessageService;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.domain.manage.model.aggregates.ApplicationSystemRichInfo;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.domain.manage.model.vo.GatewayServerVO;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.infrastructure.common.ResponseCode;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.infrastructure.common.Result;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/23 15:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 网关配置管理；服务分组、网关注册、服务关联</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/wg/admin/config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayConfigManage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(GatewayConfigManage.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IConfigManageService configManageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;queryServerConfig&quot;, produces = &quot;application/json;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;GatewayServerVO&gt;&gt; <span class="title function_">queryServerConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;查询网关服务配置项信息&quot;</span>);</span><br><span class="line">            List&lt;GatewayServerVO&gt; gatewayServerVOList = configManageService.queryGatewayServerList();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), gatewayServerVOList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;查询网关服务配置项信息异常&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册网关服务节点</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groupId        分组标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gatewayId      网关标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gatewayName    网关名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gatewayAddress 网关地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;registerGateway&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">registerGatewayServerNode</span><span class="params">(<span class="meta">@RequestParam</span> String groupId, <span class="meta">@RequestParam</span> String gatewayId, <span class="meta">@RequestParam</span> String gatewayName, <span class="meta">@RequestParam</span> String gatewayAddress)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;注册网关服务节点 gatewayId：&#123;&#125; gatewayName：&#123;&#125; gatewayAddress：&#123;&#125;&quot;</span>, gatewayId, gatewayName, gatewayAddress);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> configManageService.registerGatewayServerNode(groupId, gatewayId, gatewayName, gatewayAddress);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), isSuccess);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;注册网关服务节点异常&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;queryApplicationSystemRichInfo&quot;, produces = &quot;application/json;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;ApplicationSystemRichInfo&gt; <span class="title function_">queryApplicationSystemRichInfo</span><span class="params">(<span class="meta">@RequestParam</span> String gatewayId, <span class="meta">@RequestParam</span> String systemId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;查询分配到网关下的待注册系统信息(系统、接口、方法) gatewayId：&#123;&#125;&quot;</span>, gatewayId);</span><br><span class="line">            <span class="type">ApplicationSystemRichInfo</span> <span class="variable">applicationSystemRichInfo</span> <span class="operator">=</span> configManageService.queryApplicationSystemRichInfo(gatewayId, systemId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), applicationSystemRichInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;查询分配到网关下的待注册系统信息(系统、接口、方法)异常 gatewayId：&#123;&#125;&quot;</span>, gatewayId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;queryRedisConfig&quot;, produces = &quot;application/json;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Map&lt;String, String&gt;&gt; <span class="title function_">queryRedisConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, String&gt; redisConfig = messageService.queryRedisConfig();</span><br><span class="line">            logger.info(<span class="string">&quot;查询配置中心Redis配置信息成功&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), redisConfig);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;查询配置中心Redis配置信息失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事件通知"><a href="#事件通知" class="headerlink" title="事件通知"></a>事件通知</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.center.interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.application.IConfigManageService;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.application.IMessageService;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.application.IRegisterManageService;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.domain.register.model.vo.ApplicationInterfaceMethodVO;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.domain.register.model.vo.ApplicationInterfaceVO;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.domain.register.model.vo.ApplicationSystemVO;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.infrastructure.common.Constants;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.infrastructure.common.ResponseCode;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.infrastructure.common.Result;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.center.infrastructure.pojo.ApplicationSystem;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DuplicateKeyException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/24 15:17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> RPC 服务注册管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/wg/admin/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RPCRegisterManage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(RPCRegisterManage.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IRegisterManageService registerManageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IConfigManageService configManageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;registerApplication&quot;, produces = &quot;application/json;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">registerApplication</span><span class="params">(<span class="meta">@RequestParam</span> String systemId,</span></span><br><span class="line"><span class="params">                                               <span class="meta">@RequestParam</span> String systemName,</span></span><br><span class="line"><span class="params">                                               <span class="meta">@RequestParam</span> String systemType,</span></span><br><span class="line"><span class="params">                                               <span class="meta">@RequestParam</span> String systemRegistry)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;注册应用服务 systemId：&#123;&#125;&quot;</span>, systemId);</span><br><span class="line">            <span class="type">ApplicationSystemVO</span> <span class="variable">applicationSystemVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationSystemVO</span>();</span><br><span class="line">            applicationSystemVO.setSystemId(systemId);</span><br><span class="line">            applicationSystemVO.setSystemName(systemName);</span><br><span class="line">            applicationSystemVO.setSystemType(systemType);</span><br><span class="line">            applicationSystemVO.setSystemRegistry(systemRegistry);</span><br><span class="line">            registerManageService.registerApplication(applicationSystemVO);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;注册应用服务重复 systemId：&#123;&#125;&quot;</span>, systemId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.INDEX_DUP.getCode(), e.getMessage(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;注册应用服务失败 systemId：&#123;&#125;&quot;</span>, systemId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;registerApplicationInterface&quot;, produces = &quot;application/json;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">registerApplicationInterface</span><span class="params">(<span class="meta">@RequestParam</span> String systemId,</span></span><br><span class="line"><span class="params">                                                        <span class="meta">@RequestParam</span> String interfaceId,</span></span><br><span class="line"><span class="params">                                                        <span class="meta">@RequestParam</span> String interfaceName,</span></span><br><span class="line"><span class="params">                                                        <span class="meta">@RequestParam</span> String interfaceVersion)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;注册应用接口 systemId：&#123;&#125; interfaceId：&#123;&#125;&quot;</span>, systemId, interfaceId);</span><br><span class="line">            <span class="type">ApplicationInterfaceVO</span> <span class="variable">applicationInterfaceVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationInterfaceVO</span>();</span><br><span class="line">            applicationInterfaceVO.setSystemId(systemId);</span><br><span class="line">            applicationInterfaceVO.setInterfaceId(interfaceId);</span><br><span class="line">            applicationInterfaceVO.setInterfaceName(interfaceName);</span><br><span class="line">            applicationInterfaceVO.setInterfaceVersion(interfaceVersion);</span><br><span class="line">            registerManageService.registerApplicationInterface(applicationInterfaceVO);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;注册应用接口重复 systemId：&#123;&#125; interfaceId：&#123;&#125;&quot;</span>, systemId, interfaceId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.INDEX_DUP.getCode(), e.getMessage(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;注册应用接口失败 systemId：&#123;&#125; interfaceId：&#123;&#125;&quot;</span>, systemId, interfaceId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;registerApplicationInterfaceMethod&quot;, produces = &quot;application/json;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">registerApplicationInterfaceMethod</span><span class="params">(<span class="meta">@RequestParam</span> String systemId,</span></span><br><span class="line"><span class="params">                                                              <span class="meta">@RequestParam</span> String interfaceId,</span></span><br><span class="line"><span class="params">                                                              <span class="meta">@RequestParam</span> String methodId,</span></span><br><span class="line"><span class="params">                                                              <span class="meta">@RequestParam</span> String methodName,</span></span><br><span class="line"><span class="params">                                                              <span class="meta">@RequestParam</span> String parameterType,</span></span><br><span class="line"><span class="params">                                                              <span class="meta">@RequestParam</span> String uri,</span></span><br><span class="line"><span class="params">                                                              <span class="meta">@RequestParam</span> String httpCommandType,</span></span><br><span class="line"><span class="params">                                                              <span class="meta">@RequestParam</span> Integer auth)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;注册应用接口方法 systemId：&#123;&#125; interfaceId：&#123;&#125; methodId：&#123;&#125;&quot;</span>, systemId, interfaceId, methodId);</span><br><span class="line">            <span class="type">ApplicationInterfaceMethodVO</span> <span class="variable">applicationInterfaceMethodVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationInterfaceMethodVO</span>();</span><br><span class="line">            applicationInterfaceMethodVO.setSystemId(systemId);</span><br><span class="line">            applicationInterfaceMethodVO.setInterfaceId(interfaceId);</span><br><span class="line">            applicationInterfaceMethodVO.setMethodId(methodId);</span><br><span class="line">            applicationInterfaceMethodVO.setMethodName(methodName);</span><br><span class="line">            applicationInterfaceMethodVO.setParameterType(parameterType);</span><br><span class="line">            applicationInterfaceMethodVO.setUri(uri);</span><br><span class="line">            applicationInterfaceMethodVO.setHttpCommandType(httpCommandType);</span><br><span class="line">            applicationInterfaceMethodVO.setAuth(auth);</span><br><span class="line">            registerManageService.registerApplicationInterfaceMethod(applicationInterfaceMethodVO);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;注册应用接口方法重复 systemId：&#123;&#125; interfaceId：&#123;&#125; methodId：&#123;&#125;&quot;</span>, systemId, interfaceId, methodId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.INDEX_DUP.getCode(), e.getMessage(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;注册应用接口方法 systemId：&#123;&#125; interfaceId：&#123;&#125; methodId：&#123;&#125;&quot;</span>, systemId, interfaceId, methodId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;registerEvent&quot;, produces = &quot;application/json;charset=utf-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">registerEvent</span><span class="params">(<span class="meta">@RequestParam</span> String systemId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">gatewayId</span> <span class="operator">=</span> configManageService.queryGatewayDistribution(systemId);</span><br><span class="line">            messageService.pushMessage(gatewayId, systemId);</span><br><span class="line">            logger.info(<span class="string">&quot;应用信息注册完成通知成功 systemId：&#123;&#125;&quot;</span>, systemId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.SUCCESS.getCode(), ResponseCode.SUCCESS.getInfo(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;应用信息注册完成通知失败 systemId：&#123;&#125;&quot;</span>, systemId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;(ResponseCode.UN_ERROR.getCode(), e.getMessage(), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里通了一个注册事件，既可以被 api-gateway-sdk 使用，也可以被运用平台调用，进行消息推送，让网关服务拉取最新的系统信息。</p>
</blockquote>
<h2 id="网关助手"><a href="#网关助手" class="headerlink" title="网关助手"></a>网关助手</h2><p>为了能收到来自注册中心的消息推送，那么网关助手服务也需要连接到对应的 Redis 服务上。那么这里并不需要用户在网关助手类中配置 Redis 的连接信息，而是通过优化的方式从注册中心拉取 Redis 连接信息，到网关助手中进行注册。因为只有这样，才能减少用户的配置，并做到统一的管理。</p>
<h3 id="连接服务"><a href="#连接服务" class="headerlink" title="连接服务"></a>连接服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RedisConnectionFactory <span class="title function_">redisConnectionFactory</span><span class="params">(GatewayServiceProperties properties, GatewayCenterService gatewayCenterService)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 拉取注册中心的 Redis 配置信息</span></span><br><span class="line">    Map&lt;String, String&gt; redisConfig = gatewayCenterService.queryRedisConfig(properties.getAddress());</span><br><span class="line">    <span class="comment">// 2. 构建 Redis 服务</span></span><br><span class="line">    <span class="type">RedisStandaloneConfiguration</span> <span class="variable">standaloneConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisStandaloneConfiguration</span>();</span><br><span class="line">    standaloneConfig.setHostName(redisConfig.get(<span class="string">&quot;host&quot;</span>));</span><br><span class="line">    standaloneConfig.setPort(Integer.parseInt(redisConfig.get(<span class="string">&quot;port&quot;</span>)));</span><br><span class="line">    <span class="comment">// 3. 默认配置信息；一般这些配置可以被抽取出来</span></span><br><span class="line">    <span class="type">JedisPoolConfig</span> <span class="variable">poolConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">    poolConfig.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">    poolConfig.setMaxWaitMillis(<span class="number">30</span> * <span class="number">1000</span>);</span><br><span class="line">    poolConfig.setMinIdle(<span class="number">20</span>);</span><br><span class="line">    poolConfig.setMaxIdle(<span class="number">40</span>);</span><br><span class="line">    poolConfig.setTestWhileIdle(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 4. 创建 Redis 配置</span></span><br><span class="line">    <span class="type">JedisClientConfiguration</span> <span class="variable">clientConfig</span> <span class="operator">=</span> JedisClientConfiguration.builder()</span><br><span class="line">            .connectTimeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">            .clientName(<span class="string">&quot;api-gateway-assist-redis-&quot;</span> + properties.getGatewayId())</span><br><span class="line">            .usePooling().poolConfig(poolConfig).build();</span><br><span class="line">    <span class="comment">// 5. 实例化 Redis 链接对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JedisConnectionFactory</span>(standaloneConfig, clientConfig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageListenerAdapter <span class="title function_">msgAgreementListenerAdapter</span><span class="params">(GatewayAssistantApplication gatewayAssistantApplication)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MessageListenerAdapter</span>(gatewayAssistantApplication, <span class="string">&quot;receiveMessage&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title function_">container</span><span class="params">(GatewayServiceProperties properties, RedisConnectionFactory redisConnectionFactory, MessageListenerAdapter msgAgreementListenerAdapter)</span> &#123;</span><br><span class="line">    <span class="type">RedisMessageListenerContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisMessageListenerContainer</span>();</span><br><span class="line">    container.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">    <span class="comment">//  container.addMessageListener(msgAgreementListenerAdapter, new PatternTopic(&quot;api-gateway-g4&quot;));</span></span><br><span class="line">    container.addMessageListener(msgAgreementListenerAdapter, <span class="keyword">new</span> <span class="title class_">PatternTopic</span>(properties.getGatewayId()));</span><br><span class="line">    <span class="keyword">return</span> container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>redisConnectionFactory 方法用于创建Redis连接工厂，它通过调用 GatewayCenterService 的 queryRedisConfig 方法获取注册中心的 Redis 配置信息，然后根据该信息构建 Redis 服务的连接配置。JedisClientConfiguration是Redis客户端的配置类，用于配置 Redis 连接池的参数，如最大连接数、最大空闲连接数、连接超时时间等。注意：JedisPoolConfig 一般都是固定配置，也可以从注册中心进行拉取。</p>
<p>msgAgreementListenerAdapter 方法用于创建消息监听器适配器，它将 GatewayAssistantApplication 类中的 receiveMessage 方法作为消息监听器。</p>
<p>container 方法用于创建 Redis 消息监听容器，它使用 Redis 连接工厂和消息监听器适配器来创建一个Redis消息监听容器，并将其绑定到指定的主题（topic）上。</p>
<p>在这个例子中，它将容器绑定到了 GatewayServiceProperties 类中定义的网关ID作为主题上。这样，当有消息发送到该主题时，该容器就会接收到并调用对应的消息监听器处理该消息。</p>
</blockquote>
<h3 id="消息订阅"><a href="#消息订阅" class="headerlink" title="消息订阅"></a>消息订阅</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.assist.applicaton;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.assist.config.GatewayServiceProperties;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.assist.domain.model.aggregates.ApplicationSystemRichInfo;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.assist.domain.model.vo.ApplicationInterfaceMethodVO;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.assist.domain.model.vo.ApplicationInterfaceVO;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.assist.domain.model.vo.ApplicationSystemVO;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.assist.domain.service.GatewayCenterService;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.core.mapping.HttpRequestType;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.core.mapping.HttpStatement;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.core.session.Configuration;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.ContextClosedEvent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/25 10:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 网关应用 与 Spring 链接，调用网关注册和接口拉取</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayAssistantApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span>, ApplicationListener&lt;ContextClosedEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(GatewayAssistantApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GatewayServiceProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GatewayCenterService gatewayCenterService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel gatewaySocketServerChannel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GatewayAssistantApplication</span><span class="params">(GatewayServiceProperties properties, GatewayCenterService gatewayCenterService, Configuration configuration, Channel gatewaySocketServerChannel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.properties = properties;</span><br><span class="line">        <span class="built_in">this</span>.gatewayCenterService = gatewayCenterService;</span><br><span class="line">        <span class="built_in">this</span>.configuration = configuration;</span><br><span class="line">        <span class="built_in">this</span>.gatewaySocketServerChannel = gatewaySocketServerChannel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 注册网关服务；每一个用于转换 HTTP 协议泛化调用到 RPC 接口的网关都是一个算力，这些算力需要注册网关配置中心</span></span><br><span class="line">            gatewayCenterService.doRegister(properties.getAddress(),</span><br><span class="line">                    properties.getGroupId(),</span><br><span class="line">                    properties.getGatewayId(),</span><br><span class="line">                    properties.getGatewayName(),</span><br><span class="line">                    properties.getGatewayAddress());</span><br><span class="line"></span><br><span class="line">            addMappers(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;网关服务启动失败，停止服务。&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMappers</span><span class="params">(String systemId)</span> &#123;</span><br><span class="line">        <span class="comment">// 2. 拉取网关配置；每个网关算力都会在注册中心分配上需要映射的RPC服务信息，包括；系统、接口、方法</span></span><br><span class="line">        <span class="type">ApplicationSystemRichInfo</span> <span class="variable">applicationSystemRichInfo</span> <span class="operator">=</span> gatewayCenterService.pullApplicationSystemRichInfo(properties.getAddress(), properties.getGatewayId(), systemId);</span><br><span class="line"></span><br><span class="line">        List&lt;ApplicationSystemVO&gt; applicationSystemVOList = applicationSystemRichInfo.getApplicationSystemVOList();</span><br><span class="line">        <span class="keyword">if</span> (applicationSystemVOList.isEmpty()) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;网关&#123;&#125;服务注册映射为空，请排查 gatewayCenterService.pullApplicationSystemRichInfo 是否检索到此网关算力需要拉取的配置数据。&quot;</span>, systemId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ApplicationSystemVO system : applicationSystemVOList) &#123;</span><br><span class="line">            List&lt;ApplicationInterfaceVO&gt; interfaceList = system.getInterfaceList();</span><br><span class="line">            <span class="keyword">for</span> (ApplicationInterfaceVO interfaceVO : interfaceList) &#123;</span><br><span class="line">                <span class="comment">// 2.1 创建配置信息加载注册</span></span><br><span class="line">                configuration.registerConfig(system.getSystemId(), system.getSystemRegistry(), interfaceVO.getInterfaceId(), interfaceVO.getInterfaceVersion());</span><br><span class="line">                List&lt;ApplicationInterfaceMethodVO&gt; methodList = interfaceVO.getMethodList();</span><br><span class="line">                <span class="comment">// 2.2 注册系统服务接口信息</span></span><br><span class="line">                <span class="keyword">for</span> (ApplicationInterfaceMethodVO method : methodList) &#123;</span><br><span class="line">                    <span class="type">HttpStatement</span> <span class="variable">httpStatement</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpStatement</span>(</span><br><span class="line">                            system.getSystemId(),</span><br><span class="line">                            interfaceVO.getInterfaceId(),</span><br><span class="line">                            method.getMethodId(),</span><br><span class="line">                            method.getUri(),</span><br><span class="line">                            HttpRequestType.valueOf(method.getHttpCommandType()),</span><br><span class="line">                            method.getParameterType(),</span><br><span class="line">                            method.isAuth());</span><br><span class="line">                    configuration.addMapper(httpStatement);</span><br><span class="line">                    logger.info(<span class="string">&quot;网关服务注册映射 系统：&#123;&#125; 接口：&#123;&#125; 方法：&#123;&#125;&quot;</span>, system.getSystemId(), interfaceVO.getInterfaceId(), method.getMethodId());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextClosedEvent contextClosedEvent)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (gatewaySocketServerChannel.isActive()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;应用容器关闭，Api网关服务关闭。localAddress：&#123;&#125;&quot;</span>, gatewaySocketServerChannel.localAddress());</span><br><span class="line">                gatewaySocketServerChannel.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;应用容器关闭，Api网关服务关闭失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMessage</span><span class="params">(Object message)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;【事件通知】接收注册中心推送消息 message：&#123;&#125;&quot;</span>, message);</span><br><span class="line">        addMappers(message.toString().substring(<span class="number">1</span>, message.toString().length() - <span class="number">1</span>));</span><br><span class="line">        <span class="comment">//TODO 后续消息接收方法直接通过 configuration.addMapper(httpStatement) 注册映射</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将注册映射逻辑抽取出来作为单独的方法，通过这样的方式，现在我们拉取接口一方面是网关助手系统也就是网关引擎启动的时候进行拉取，另外一种是已经在运行时候，通过事件的通知进行拉取。</p>
<p>注意：这里的 pullApplicationSystemRichInfo 增加了参数 systemId，也就是 网关中心的 queryApplicationSystemRichInfo 方法增加了参数 systemId，</p>
<p>也就增加了一下逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果未指定 systemId ,则查询当前网关下的所有系统</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(systemId)) &#123;</span><br><span class="line">    systemIdList = configManageRepository.queryGatewayDistributionSystemIdList(gatewayId);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 指定则定向拉取系统</span></span><br><span class="line">    systemIdList.add(systemId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次网关引擎初始化启动时，未指定 systemId，注册当前网关下的所有系统接口，之后就通过事件通知指定了 systemId，只注册指定系统下的接口。</p>
<h2 id="网关SDK"><a href="#网关SDK" class="headerlink" title="网关SDK"></a>网关SDK</h2><h3 id="事件通知注册"><a href="#事件通知注册" class="headerlink" title="事件通知注册"></a>事件通知注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.sdk.domain.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.http.HttpUtil;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.sdk.GatewayException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.sdk.common.Result;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.TypeReference;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/30 09:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 网关中心服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayCenterService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(GatewayCenterService.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRegisterApplication</span><span class="params">(String address, String systemId, String systemName, String systemType, String systemRegistry)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">&quot;systemId&quot;</span>, systemId);</span><br><span class="line">        paramMap.put(<span class="string">&quot;systemName&quot;</span>, systemName);</span><br><span class="line">        paramMap.put(<span class="string">&quot;systemType&quot;</span>, systemType);</span><br><span class="line">        paramMap.put(<span class="string">&quot;systemRegistry&quot;</span>, systemRegistry);</span><br><span class="line">        String resultStr;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resultStr = HttpUtil.post(address + <span class="string">&quot;/wg/admin/register/registerApplication&quot;</span>, paramMap, <span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;应用服务注册异常，链接资源不可用：&#123;&#125;&quot;</span>, address + <span class="string">&quot;/wg/admin/register/registerApplication&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        Result&lt;Boolean&gt; result = JSON.parseObject(resultStr, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Result&lt;Boolean&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        logger.info(<span class="string">&quot;向网关中心注册应用服务 systemId：&#123;&#125; systemName：&#123;&#125; 注册结果：&#123;&#125;&quot;</span>, systemId, systemName, resultStr);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;0000&quot;</span>.equals(result.getCode()) &amp;&amp; !<span class="string">&quot;0003&quot;</span>.equals(result.getCode())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GatewayException</span>(<span class="string">&quot;注册应用服务异常 [systemId：&quot;</span> + systemId + <span class="string">&quot;] 、[systemRegistry：&quot;</span> + systemRegistry + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRegisterApplicationInterface</span><span class="params">(String address, String systemId, String interfaceId, String interfaceName, String interfaceVersion)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">&quot;systemId&quot;</span>, systemId);</span><br><span class="line">        paramMap.put(<span class="string">&quot;interfaceId&quot;</span>, interfaceId);</span><br><span class="line">        paramMap.put(<span class="string">&quot;interfaceName&quot;</span>, interfaceName);</span><br><span class="line">        paramMap.put(<span class="string">&quot;interfaceVersion&quot;</span>, interfaceVersion);</span><br><span class="line">        String resultStr;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resultStr = HttpUtil.post(address + <span class="string">&quot;/wg/admin/register/registerApplicationInterface&quot;</span>, paramMap, <span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;应用服务接口注册异常，链接资源不可用：&#123;&#125;&quot;</span>, address + <span class="string">&quot;/wg/admin/register/registerApplicationInterface&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        Result&lt;Boolean&gt; result = JSON.parseObject(resultStr, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Result&lt;Boolean&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        logger.info(<span class="string">&quot;向网关中心注册应用接口服务 systemId：&#123;&#125; interfaceId：&#123;&#125; interfaceName：&#123;&#125; 注册结果：&#123;&#125;&quot;</span>, systemId, interfaceId, interfaceName, resultStr);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;0000&quot;</span>.equals(result.getCode()) &amp;&amp; !<span class="string">&quot;0003&quot;</span>.equals(result.getCode())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GatewayException</span>(<span class="string">&quot;向网关中心注册应用接口服务异常 [systemId：&quot;</span> + systemId + <span class="string">&quot;] 、[interfaceId：&quot;</span> + interfaceId + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRegisterApplicationInterfaceMethod</span><span class="params">(String address,</span></span><br><span class="line"><span class="params">                                                     String systemId,</span></span><br><span class="line"><span class="params">                                                     String interfaceId,</span></span><br><span class="line"><span class="params">                                                     String methodId,</span></span><br><span class="line"><span class="params">                                                     String methodName,</span></span><br><span class="line"><span class="params">                                                     String parameterType,</span></span><br><span class="line"><span class="params">                                                     String uri,</span></span><br><span class="line"><span class="params">                                                     String httpCommandType,</span></span><br><span class="line"><span class="params">                                                     Integer auth)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">&quot;systemId&quot;</span>, systemId);</span><br><span class="line">        paramMap.put(<span class="string">&quot;interfaceId&quot;</span>, interfaceId);</span><br><span class="line">        paramMap.put(<span class="string">&quot;methodId&quot;</span>, methodId);</span><br><span class="line">        paramMap.put(<span class="string">&quot;methodName&quot;</span>, methodName);</span><br><span class="line">        paramMap.put(<span class="string">&quot;parameterType&quot;</span>, parameterType);</span><br><span class="line">        paramMap.put(<span class="string">&quot;uri&quot;</span>, uri);</span><br><span class="line">        paramMap.put(<span class="string">&quot;httpCommandType&quot;</span>, httpCommandType);</span><br><span class="line">        paramMap.put(<span class="string">&quot;auth&quot;</span>, auth);</span><br><span class="line"></span><br><span class="line">        String resultStr;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resultStr = HttpUtil.post(address + <span class="string">&quot;/wg/admin/register/registerApplicationInterfaceMethod&quot;</span>, paramMap, <span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;应用服务接口注册方法异常，链接资源不可用：&#123;&#125;&quot;</span>, address + <span class="string">&quot;/wg/admin/register/registerApplicationInterfaceMethod&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        Result&lt;Boolean&gt; result = JSON.parseObject(resultStr, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Result&lt;Boolean&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        logger.info(<span class="string">&quot;向网关中心注册应用接口方法服务 systemId：&#123;&#125; interfaceId：&#123;&#125; methodId：&#123;&#125; 注册结果：&#123;&#125;&quot;</span>, systemId, interfaceId, methodId, resultStr);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;0000&quot;</span>.equals(result.getCode()) &amp;&amp; !<span class="string">&quot;0003&quot;</span>.equals(result.getCode()))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GatewayException</span>(<span class="string">&quot;向网关中心注册应用接口方法服务异常 [systemId：&quot;</span> + systemId + <span class="string">&quot;] 、[interfaceId：&quot;</span> + interfaceId + <span class="string">&quot;]、[methodId：]&quot;</span> + methodId + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRegisterEvent</span><span class="params">(String address, String systemId)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">&quot;systemId&quot;</span>, systemId);</span><br><span class="line">        String resultStr;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resultStr = HttpUtil.post(address + <span class="string">&quot;/wg/admin/register/registerEvent&quot;</span>, paramMap, <span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;应用信息注册完成通知异常，链接资源不可用：&#123;&#125;&quot;</span>, address + <span class="string">&quot;/wg/admin/register/registerEvent&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        Result&lt;Boolean&gt; result = JSON.parseObject(resultStr, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Result&lt;Boolean&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        logger.info(<span class="string">&quot;应用信息注册完成通知 systemId：&#123;&#125; 注册结果：&#123;&#125;&quot;</span>, systemId, resultStr);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;0000&quot;</span>.equals(result.getCode()))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GatewayException</span>(<span class="string">&quot;向网关中心注册完成通知异常 [systemId：&quot;</span> + systemId + <span class="string">&quot;] &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="应用服务注册"><a href="#应用服务注册" class="headerlink" title="应用服务注册"></a>应用服务注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ray.gateway.sdk.application;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.sdk.GatewayException;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.sdk.annotation.ApiProducerClazz;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.sdk.annotation.ApiProducerMethod;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.sdk.config.GatewaySDKServiceProperties;</span><br><span class="line"><span class="keyword">import</span> cn.ray.gateway.sdk.domain.service.GatewayCenterService;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ray</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/29 15:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 应用服务注册</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewaySDKApplication</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(GatewaySDKApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GatewaySDKServiceProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GatewayCenterService gatewayCenterService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GatewaySDKApplication</span><span class="params">(GatewaySDKServiceProperties properties, GatewayCenterService gatewayCenterService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.properties = properties;</span><br><span class="line">        <span class="built_in">this</span>.gatewayCenterService = gatewayCenterService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">ApiProducerClazz</span> <span class="variable">apiProducerClazz</span> <span class="operator">=</span> bean.getClass().getAnnotation(ApiProducerClazz.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == apiProducerClazz) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1. 系统信息</span></span><br><span class="line">        logger.info(<span class="string">&quot;\n应用注册：系统信息 \nsystemId: &#123;&#125; \nsystemName: &#123;&#125; \nsystemType: &#123;&#125; \nsystemRegistry: &#123;&#125;&quot;</span>, properties.getSystemId(), properties.getSystemName(), <span class="string">&quot;RPC&quot;</span>, properties.getSystemRegistry());</span><br><span class="line">        gatewayCenterService.doRegisterApplication(properties.getAddress(), properties.getSystemId(), properties.getSystemName(), <span class="string">&quot;RPC&quot;</span>, properties.getSystemRegistry());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 接口信息</span></span><br><span class="line">        Class&lt;?&gt;[] interfaces = bean.getClass().getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (interfaces.length != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GatewayException</span>(bean.getClass().getName() + <span class="string">&quot;interfaces not one this is &quot;</span> + JSON.toJSONString(interfaces));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">interfaceId</span> <span class="operator">=</span> interfaces[<span class="number">0</span>].getName();</span><br><span class="line">        logger.info(<span class="string">&quot;\n应用注册：接口信息 \nsystemId: &#123;&#125; \ninterfaceId: &#123;&#125; \ninterfaceName: &#123;&#125; \ninterfaceVersion: &#123;&#125;&quot;</span>, properties.getSystemId(), interfaceId, apiProducerClazz.interfaceName(), apiProducerClazz.interfaceVersion());</span><br><span class="line">        gatewayCenterService.doRegisterApplicationInterface(</span><br><span class="line">                properties.getAddress(),</span><br><span class="line">                properties.getSystemId(),</span><br><span class="line">                interfaceId,</span><br><span class="line">                apiProducerClazz.interfaceName(),</span><br><span class="line">                apiProducerClazz.interfaceVersion()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 方法信息</span></span><br><span class="line">        Method[] methods = bean.getClass().getMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="type">ApiProducerMethod</span> <span class="variable">apiProducerMethod</span> <span class="operator">=</span> method.getAnnotation(ApiProducerMethod.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == apiProducerMethod) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析参数</span></span><br><span class="line">            Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">parameters</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; clazz : parameterTypes) &#123;</span><br><span class="line">                parameters.append(clazz.getName()).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">parameterType</span> <span class="operator">=</span> parameters.toString().substring(<span class="number">0</span>,parameters.toString().lastIndexOf(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">            logger.info(<span class="string">&quot;\n应用注册：方法信息 \nsystemId: &#123;&#125; \ninterfaceId: &#123;&#125; \nmethodId: &#123;&#125; \nmethodName: &#123;&#125; \nparameterType: &#123;&#125; \nuri: &#123;&#125; \nhttpCommandType: &#123;&#125; \nauth: &#123;&#125;&quot;</span>,</span><br><span class="line">                    properties.getSystemId(),</span><br><span class="line">                    bean.getClass().getName(),</span><br><span class="line">                    method.getName(),</span><br><span class="line">                    apiProducerMethod.methodName(),</span><br><span class="line">                    parameterType,</span><br><span class="line">                    apiProducerMethod.uri(),</span><br><span class="line">                    apiProducerMethod.httpRequestType(),</span><br><span class="line">                    apiProducerMethod.auth());</span><br><span class="line">            gatewayCenterService.doRegisterApplicationInterfaceMethod(</span><br><span class="line">                    properties.getAddress(),</span><br><span class="line">                    properties.getSystemId(),</span><br><span class="line">                    interfaceId,</span><br><span class="line">                    method.getName(),</span><br><span class="line">                    apiProducerMethod.methodName(),</span><br><span class="line">                    parameterType,</span><br><span class="line">                    apiProducerMethod.uri(),</span><br><span class="line">                    apiProducerMethod.httpRequestType(),</span><br><span class="line">                    apiProducerMethod.auth()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册完成，执行事件通知</span></span><br><span class="line">        gatewayCenterService.doRegisterEvent(properties.getAddress(), properties.getSystemId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里后续可以在 sdk 注册接口时，向注册中心查询判断是否该接口已经注册，存在于数据库中，如果是新注册就将该接口的信息推送给注册中心，注册中心再将该消息发布，对应的网关引擎监听到该信息后，根据接口信息向网关通信组件 core 中的 Configuration 注册映射。</p>
</blockquote>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><ol>
<li><p>启动 Docker 容器，启动 zookeeper 注册中心、启动 Redis 服务</p>
</li>
<li><p>清空数据库 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> application_ <span class="keyword">system</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> application_interface;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> application_ interface_method;</span><br></pre></td></tr></table></figure>
<p>为的就是在 api-gateway-engine 启动的时候，不让它拉取到任何接口信息，当后续注册新的接口信息时候，再拉取。</p>
</li>
<li><p>启动 api-gateway-center 注册中心，保证后续的流程可以启动。</p>
</li>
<li><p>打包最新 api-gateway-assist-05，部署 api-gateway-engine 镜像文件到 Docker 容器。</p>
</li>
<li><p>启动 api-gateway-test。</p>
</li>
<li><p>观察 Docker 中 api-gateway-engine 的日志信息，是否有映射完成操作。</p>
</li>
</ol>
<h2 id="RPC-应用服务-SDK-未启动："><a href="#RPC-应用服务-SDK-未启动：" class="headerlink" title="RPC 应用服务(SDK)未启动："></a>RPC 应用服务(SDK)未启动：</h2><p>api-gateway-engine</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-测试-1.png" alt="22-测试-1"></p>
<p>api-gateway-center</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-测试-2.png" alt="22-测试-2"></p>
<h2 id="RPC-应用服务-SDK-启动后："><a href="#RPC-应用服务-SDK-启动后：" class="headerlink" title="RPC 应用服务(SDK)启动后："></a>RPC 应用服务(SDK)启动后：</h2><p>api-gateway-test</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-测试-3.png" alt="22-测试-3"></p>
<p>api-gateway-center</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-测试-4.png" alt="22-测试-4"></p>
<p>api-gateway-engine</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-测试-5.png" alt="22-测试-5"></p>
<h2 id="Postman"><a href="#Postman" class="headerlink" title="Postman"></a>Postman</h2><p>GET</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-测试-6.png" alt="22-测试-6"></p>
<p>POST</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-测试-7.png" alt="22-测试-7"></p>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><h2 id="大致流程"><a href="#大致流程" class="headerlink" title="大致流程"></a>大致流程</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/image/api-gateway/22-思考.png" alt="Redis发布订阅大致流程"></p>
<ol>
<li>网关引擎初始化启动时，拉取注册中心数据库中已有的所有系统应用接口信息，完成 <code>Configuration.addMapper</code> 注册，并根据当前网关ID监听注册中心。</li>
<li>当有一个新的 RPC 应用服务加入网关时，将其带有注解 <code>@ApiProducerClazz</code>、<code>@ApiProducerMethod</code> 的类和方法的信息持久化到网关中心的数据库中，之后调用 <code>doRegisterEvent</code> 事件发布接口，通知网关中心发布消息。</li>
<li>网关中心接收到发布请求后，通过 <code>redisMessageTemplate.convertAndSend(gatewayId,systemId);</code> 发布消息。</li>
<li>网关引擎运行中，监听到消息发布，接收到网关中心推送过来的systemId，之后根据 systemId 拉取该系统下所有的接口信息，并根据 <code>configuration.addMapper(httpStatement);</code>完成通信组件 core 的配置注册。</li>
</ol>
<h2 id="Redis消息订阅发布"><a href="#Redis消息订阅发布" class="headerlink" title="Redis消息订阅发布"></a>Redis消息订阅发布</h2><p>Redis一般都是用于缓存较多，这里记录一下用于事件推送的方法</p>
<h3 id="Redis事件发布端"><a href="#Redis事件发布端" class="headerlink" title="Redis事件发布端"></a>Redis事件发布端</h3><p>RedisTemplate#convertAndSend：发布消息，指明接收方 Topic 通信信道以及消息内容。</p>
<h3 id="Redis-监听器"><a href="#Redis-监听器" class="headerlink" title="Redis 监听器"></a>Redis 监听器</h3><details class="lake-collapse"><summary id="u5a65a4f5"><span class="ne-text" style="font-size: 16px">RedisConnectionFactory：负责设置连接参数，Redis服务地址。</span></summary><p id="u3537b2a4" class="ne-p" style="margin: 0; padding: 0; min-height: 24px"><span class="ne-text" style="font-size: 16px">RedisConnectionFactory 是 Spring Data Redis 提供的一个接口，用于获取 Redis 连接的工厂类。它可以通过配置来创建实例，或者通过自动配置的方式从应用程序的上下文中获取。</span></p><p id="u64139c92" class="ne-p" style="margin: 0; padding: 0; min-height: 24px"><span class="ne-text" style="font-size: 16px">在 Spring Boot 应用程序中，可以通过配置文件或者编程方式来配置 Redis 连接工厂。通常，可以在 application.properties 或 application.yml 文件中配置 Redis 连接信息，例如 Redis 的主机名、端口号、密码等。Spring Boot 会自动读取这些配置，并根据配置创建一个 RedisConnectionFactory 的实例。</span></p><p id="u11e62f58" class="ne-p" style="margin: 0; padding: 0; min-height: 24px"><span class="ne-text" style="font-size: 16px">另外，还可以通过编程方式来配置 RedisConnectionFactory。在这种情况下，可以在 Spring 配置类中手动创建 RedisConnectionFactory 对象，并设置连接相关的属性，例如主机名、端口号、密码等。</span></p><p id="uc30ee3e7" class="ne-p" style="margin: 0; padding: 0; min-height: 24px"><span class="ne-text" style="font-size: 16px">总结起来，RedisConnectionFactory 可以通过配置文件或者编程方式进行配置，从而创建一个可以用于获取 Redis 连接的工厂实例。具体的配置方式可以根据项目的需求和使用的框架来确定。</span></p></details>

<p>在 assist 中注入连接工厂 Bean 并修改配置，从注册中心拉取 Redis 的IP端口信息(properties)，创建 Jedis 客户端连接（不需要在 assist 重新配置 Redis 服务地址，减少用户的操作，也更方便统一配置）。</p>
<p>RedisMessageListenerContainer：注入消息监听器容器，需要设置连接工厂和监听器适配器。并将消息通信 Topic 与监听器适配器绑定。</p>
<p>MessageListenerAdapter：指明消息处理委托对象，以及消息处理方法(最终发布方的消息会被该方法接收）。</p>
<h2 id="面试中可能会问到的问题"><a href="#面试中可能会问到的问题" class="headerlink" title="面试中可能会问到的问题"></a>面试中可能会问到的问题</h2><h3 id="Redis-发布订阅（Publish-Subscribe）与消息队列-MQ-的区别？"><a href="#Redis-发布订阅（Publish-Subscribe）与消息队列-MQ-的区别？" class="headerlink" title="Redis 发布订阅（Publish/Subscribe）与消息队列 MQ 的区别？"></a>Redis 发布订阅（Publish/Subscribe）与消息队列 MQ 的区别？</h3><p>Redis发布订阅（Publish/Subscribe）和消息队列都是用于实现消息传递的机制，但它们的实现方式和应用场景略有不同。</p>
<p>Redis发布订阅模式是一种广播机制，它允许订阅者（subscriber）接收到发布者（publisher）发送的消息。发布者将消息发送到指定的频道（channel），而订阅者则可以订阅一个或多个频道，以接收该频道中的所有消息。这种模式适用于消息的广播场景，如实时聊天、新闻推送等。</p>
<p>消息队列则是一种点对点（P2P）的消息传递方式，它将消息发送到队列中，然后由消费者（consumer）从队列中取出并处理该消息。消息队列可以保证消息的可靠性传递，同时也可以实现消息的异步处理，从而提高系统的吞吐量和可伸缩性。消息队列适用于异步处理、任务调度等场景。</p>
<p>因此，Redis发布订阅和消息队列虽然都可以实现消息传递，但在应用场景和实现方式上略有不同，需要根据实际需求选择合适的机制。</p>
<h3 id="那-Redis-发布订阅有什么局限性？"><a href="#那-Redis-发布订阅有什么局限性？" class="headerlink" title="那 Redis 发布订阅有什么局限性？"></a>那 Redis 发布订阅有什么局限性？</h3><p>Redis发布订阅模式的局限性主要包括以下几点：</p>
<ol>
<li>可靠性：Redis发布订阅模式不保证消息的可靠性，因为订阅者只能接收到自己订阅的消息，而无法保证消息是否已经被正确地传递给所有的订阅者，也无法保证消息是否已经被正确地处理。 </li>
<li>消息持久化：Redis发布订阅模式不支持消息的持久化，即当订阅者断开连接时，它将无法接收到在其离线期间发送的消息。 </li>
<li>扩展性：Redis发布订阅模式不适合处理大量的消息，因为它只能在单个Redis实例中进行处理，无法进行水平扩展。 </li>
<li>消息顺序：Redis发布订阅模式无法保证消息的顺序，因为它是异步的，消息的传递顺序可能与发布的顺序不一致。 </li>
</ol>
<p>因此，在实际应用中，如果需要保证消息的可靠性、持久化、顺序和扩展性，可以考虑使用消息队列等其他的解决方案。</p>
<h3 id="那什么场景选择-Redis-发布订阅更好？为什么选择-Redis-发布订阅做网关注册的通知？"><a href="#那什么场景选择-Redis-发布订阅更好？为什么选择-Redis-发布订阅做网关注册的通知？" class="headerlink" title="那什么场景选择 Redis 发布订阅更好？为什么选择 Redis 发布订阅做网关注册的通知？"></a>那什么场景选择 Redis 发布订阅更好？为什么选择 Redis 发布订阅做网关注册的通知？</h3><p>Redis发布订阅模式适用于以下场景：</p>
<ol>
<li><strong>实时性要求高</strong>：Redis发布订阅模式是异步的，消息的传递速度非常快，适合处理需要实时性的场景，如在线聊天、实时通知等。 </li>
<li><strong>简单的消息传递</strong>：Redis发布订阅模式非常适合处理简单的消息传递，如事件通知、状态更新等。 </li>
<li><strong>低延迟的数据处理</strong>：Redis发布订阅模式具有低延迟的特点，适合需要快速处理数据的场景，如实时数据分析、实时数据监控等。 </li>
<li><strong>简单的数据结构</strong>：Redis发布订阅模式的数据结构非常简单，易于使用和维护，适合处理简单的数据结构。 </li>
</ol>
<p>总的来说，Redis发布订阅模式适合处理实时性要求高、简单的消息传递、低延迟的数据处理、简单的数据结构等场景。如果需要处理复杂的消息传递、保证消息的可靠性、持久化、顺序和扩展性，可以考虑使用消息队列等其他的解决方案。</p>
<h3 id="Redis-发布订阅为什么实时性高，延迟低？"><a href="#Redis-发布订阅为什么实时性高，延迟低？" class="headerlink" title="Redis 发布订阅为什么实时性高，延迟低？"></a>Redis 发布订阅为什么实时性高，延迟低？</h3><p>Redis发布订阅模式具有实时性高、延迟低的特点，主要原因有以下几点：</p>
<ol>
<li><strong>异步通信</strong>：Redis发布订阅模式采用异步通信方式，发布者将消息发布到Redis服务器后，不需要等待订阅者接收消息的响应，即可继续处理其他任务，这样可以大大提高消息的传递速度。 </li>
<li><strong>内存存储</strong>：Redis是一种基于内存存储的NoSQL数据库，数据的读写非常快，可以在微秒级别内完成，这样可以大大缩短消息的传递时间。 </li>
<li><strong>单线程模型</strong>：Redis采用单线程模型，避免了多线程之间的线程切换和锁竞争，这样可以减少消息传递的延迟。 </li>
<li><strong>网络协议</strong>：Redis采用高效的网络协议，如RESP协议，可以大大提高消息的传递效率。 </li>
</ol>
<p>综上所述，Redis发布订阅模式具有实时性高、延迟低的特点，这主要得益于Redis采用了异步通信、内存存储、单线程模型和高效的网络协议等优化措施。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/avatar2.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/avatar2.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">hiriki</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://www.sherry.zone/posts/ab0d0ec1.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://www.sherry.zone/posts/ab0d0ec1.html')">二十二 订阅服务注册消息驱动网关映射</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://www.sherry.zone/posts/ab0d0ec1.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=二十二 订阅服务注册消息驱动网关映射&amp;url=http://www.sherry.zone/posts/ab0d0ec1.html&amp;pic=https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.sherry.zone" target="_blank">「hirikiのblog」</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/API%E7%BD%91%E5%85%B3/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>API网关<span class="tagsPageCount">29</span></a><a class="post-meta__box__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>服务发现<span class="tagsPageCount">8</span></a><a class="post-meta__box__tags" href="/tags/Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Redis发布订阅<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/一月.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/b06b19dc.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">二十一 应用服务接口注册到注册中心</div></div></a></div><div class="next-post pull-right"><a href="/posts/c71b2649.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/六月.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">二十三 网关运营管理后台框架搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/a1026c3d.html" title="十三章 服务发现组件搭建和注册网关连接"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-05-25</div><div class="title">十三章 服务发现组件搭建和注册网关连接</div></div></a></div><div><a href="/posts/6faa3e7b.html" title="十五章 服务配置拉取和组件使用验证"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-05-27</div><div class="title">十五章 服务配置拉取和组件使用验证</div></div></a></div><div><a href="/posts/e6d154bb.html" title="十七章 核心通信组件管理和处理服务映射"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-05-27</div><div class="title">十七章 核心通信组件管理和处理服务映射</div></div></a></div><div><a href="/posts/20dbea4.html" title="十八章 容器关闭监听和异常管理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/五月.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-05-28</div><div class="title">十八章 容器关闭监听和异常管理</div></div></a></div><div><a href="/posts/16218b34.html" title="二十五 网关Nginx负载模型配置"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/六月.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-06-02</div><div class="title">二十五 网关Nginx负载模型配置</div></div></a></div><div><a href="/posts/ca109310.html" title="二十六 动态刷新网关Nginx负载均衡配置"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/六月.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-06-03</div><div class="title">二十六 动态刷新网关Nginx负载均衡配置</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" style="display: none">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/avatar2.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://twikoo-magic.oss-cn-hangzhou.aliyuncs.com/Yurui-Neko/012.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;margin-top:4rem;text-align:center;color:rgba(255, 255, 255, 0.8);"><b style="color:#fff">分享、热爱、提升</b><b style="color:#fff"></b><b style="color:#fff"></b></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">hiriki</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hiriki" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/401060750" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">设计</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.1.</span> <span class="toc-text">注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83"><span class="toc-number">2.1.1.</span> <span class="toc-text">消息发布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E6%8E%A8%E9%80%81%E9%85%8D%E7%BD%AE-PublisherConfig"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">消息监听推送配置 PublisherConfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E8%80%85-Publisher"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">消息发布者 Publisher</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MessageServiceImpl-%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">MessageServiceImpl 消息服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-Redis-%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.2.</span> <span class="toc-text">获取 Redis 配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5"><span class="toc-number">2.1.3.</span> <span class="toc-text">事件通知</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E5%8A%A9%E6%89%8B"><span class="toc-number">2.2.</span> <span class="toc-text">网关助手</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.2.1.</span> <span class="toc-text">连接服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%AE%A2%E9%98%85"><span class="toc-number">2.2.2.</span> <span class="toc-text">消息订阅</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3SDK"><span class="toc-number">2.3.</span> <span class="toc-text">网关SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5%E6%B3%A8%E5%86%8C"><span class="toc-number">2.3.1.</span> <span class="toc-text">事件通知注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">2.3.2.</span> <span class="toc-text">应用服务注册</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RPC-%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1-SDK-%E6%9C%AA%E5%90%AF%E5%8A%A8%EF%BC%9A"><span class="toc-number">3.1.</span> <span class="toc-text">RPC 应用服务(SDK)未启动：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RPC-%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1-SDK-%E5%90%AF%E5%8A%A8%E5%90%8E%EF%BC%9A"><span class="toc-number">3.2.</span> <span class="toc-text">RPC 应用服务(SDK)启动后：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Postman"><span class="toc-number">3.3.</span> <span class="toc-text">Postman</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">思考</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">大致流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E6%B6%88%E6%81%AF%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83"><span class="toc-number">4.2.</span> <span class="toc-text">Redis消息订阅发布</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B8%83%E7%AB%AF"><span class="toc-number">4.2.1.</span> <span class="toc-text">Redis事件发布端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text">Redis 监听器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E4%B8%AD%E5%8F%AF%E8%83%BD%E4%BC%9A%E9%97%AE%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.</span> <span class="toc-text">面试中可能会问到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%EF%BC%88Publish-Subscribe%EF%BC%89%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-MQ-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">4.3.1.</span> <span class="toc-text">Redis 发布订阅（Publish&#x2F;Subscribe）与消息队列 MQ 的区别？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%A3-Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%9C%89%E4%BB%80%E4%B9%88%E5%B1%80%E9%99%90%E6%80%A7%EF%BC%9F"><span class="toc-number">4.3.2.</span> <span class="toc-text">那 Redis 发布订阅有什么局限性？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%A3%E4%BB%80%E4%B9%88%E5%9C%BA%E6%99%AF%E9%80%89%E6%8B%A9-Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%9B%B4%E5%A5%BD%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E5%81%9A%E7%BD%91%E5%85%B3%E6%B3%A8%E5%86%8C%E7%9A%84%E9%80%9A%E7%9F%A5%EF%BC%9F"><span class="toc-number">4.3.3.</span> <span class="toc-text">那什么场景选择 Redis 发布订阅更好？为什么选择 Redis 发布订阅做网关注册的通知？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E4%B8%BA%E4%BB%80%E4%B9%88%E5%AE%9E%E6%97%B6%E6%80%A7%E9%AB%98%EF%BC%8C%E5%BB%B6%E8%BF%9F%E4%BD%8E%EF%BC%9F"><span class="toc-number">4.3.4.</span> <span class="toc-text">Redis 发布订阅为什么实时性高，延迟低？</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/688757c1.html" title="TCP连接建立"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/一月.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TCP连接建立"/></a><div class="content"><a class="title" href="/posts/688757c1.html" title="TCP连接建立">TCP连接建立</a><time datetime="2024-03-29T09:21:07.952Z" title="发表于 2024-03-29 17:21:07">2024-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8b59288c.html" title="TCP连接断开"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/一月.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TCP连接断开"/></a><div class="content"><a class="title" href="/posts/8b59288c.html" title="TCP连接断开">TCP连接断开</a><time datetime="2024-03-29T09:21:07.950Z" title="发表于 2024-03-29 17:21:07">2024-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/28dddcd3.html" title="TCP基本认识"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/一月.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TCP基本认识"/></a><div class="content"><a class="title" href="/posts/28dddcd3.html" title="TCP基本认识">TCP基本认识</a><time datetime="2024-03-29T09:21:07.948Z" title="发表于 2024-03-29 17:21:07">2024-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/61920cbb.html" title="Socket编程"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/二月.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Socket编程"/></a><div class="content"><a class="title" href="/posts/61920cbb.html" title="Socket编程">Socket编程</a><time datetime="2024-03-29T09:21:07.939Z" title="发表于 2024-03-29 17:21:07">2024-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/e50d82d9.html" title="Redis线程模型"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/二月.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis线程模型"/></a><div class="content"><a class="title" href="/posts/e50d82d9.html" title="Redis线程模型">Redis线程模型</a><time datetime="2024-03-29T09:21:07.938Z" title="发表于 2024-03-29 17:21:07">2024-03-29</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:sherry2124@163.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" href="https://www.sherry.zone" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="https://www.sherry.zone" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="https://www.sherry.zone" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1314261683.cos.ap-chengdu.myqcloud.com/public/avatar2.png" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/hiriki" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/401060750" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="https://www.sherry.zone" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" href="https://www.sherry.zone" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Sherryの小屋-上班摸鱼中-6adea8?style=social&amp;logo=cakephp" alt="什么时候能够实现财富自由呀~" title="什么时候能够实现财富自由呀~"/><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2022 - 2024 By <a class="footer-bar-link" href="/" title="hiriki" target="_blank">hiriki</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">96</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">7</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/photos/"><span> 相册</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><span> 留言</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><span> 关于</span></a></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("6/25/2022 10:10:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "https://img.shields.io/badge/Sherryの小屋-打烊休息啦-6adea8?style=social&amp;logo=coffeescript";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.sherry.pub/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.sherry.pub/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.sherry.pub/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script defer src="/js/lunar.js"></script><script defer src="/js/day.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>